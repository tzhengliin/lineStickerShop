<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>客製化Line貼圖-恆哥用心做</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        background-color: #f8f9fa;
        padding-bottom: 100px;
      }
      .category-box {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .cat-title {
        color: #00b900;
        font-weight: bold;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
      .sticker-btn {
        margin: 5px;
      }
      .floating-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #333;
        color: white;
        padding: 15px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .price-tag {
        color: #ffc107;
        font-weight: bold;
        font-size: 1.2em;
      }
      .warning-text {
        color: #ff6b6b;
        font-size: 0.9em;
        font-weight: bold;
      }
      #selected-list {
        max-height: 150px;
        overflow-y: auto;
        background: #eee;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      /* 自訂用語區塊樣式 */
      .custom-section {
        border-left: 5px solid #ff6b6b;
      }
      .custom-title {
        color: #ff6b6b;
      }

      /* 載入遮罩 */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem"></div>
      <h5 class="mt-3 text-secondary">正在讀取最新的貼圖資料...</h5>
    </div>

    <div class="container mt-4">
      <h2 class="text-center mb-4" style="color: #00b900">LINE 貼圖用語挑選</h2>

      <div class="alert alert-info">
        <strong>計費說明：</strong><br />
        8張: 320元 / 16張: 640元 / 24張: 960元 / 40張: 1600元
      </div>

      <div id="content-area" class="text-center"></div>

      <div class="category-box custom-section mt-4">
        <h4 class="cat-title custom-title">★ 自訂用語 (清單沒有？自己加！)</h4>
        <div class="input-group mb-3">
          <input type="text" id="custom-input" class="form-control" placeholder="輸入想說的話，例如：早安你好 (按 Enter 加入)" />
          <button class="btn btn-danger" type="button" onclick="addCustomItem()">加入</button>
        </div>
        <div id="custom-container"></div>
      </div>

      <div class="category-box mt-4">
        <h4 class="cat-title">買家資料</h4>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label>您的稱呼 (必填)</label>
            <input type="text" id="buyer-name" class="form-control" placeholder="王小明" />
          </div>
          <div class="col-md-6 mb-3">
            <label>Line ID (必填)</label>
            <input type="text" id="buyer-line" class="form-control" placeholder="line_id_123" />
          </div>
        </div>
      </div>

      <div style="height: 120px"></div>
    </div>

    <div class="floating-footer">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <div>已選數量：<span id="count-display" class="fw-bold">0</span> 張 | 預估金額：<span id="price-display" class="price-tag">0</span> 元</div>
            <div id="upsell-msg" class="warning-text"></div>
            <div class="mt-2">
              <small>已選用語：</small>
              <div id="selected-text-preview" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; color: #ccc">(尚未選擇)</div>
            </div>
          </div>
          <div class="col-md-4 text-end mt-2 mt-md-0">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">查看清單並送出</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">確認您的選擇</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <h6>已選項目：</h6>
            <div id="selected-list"></div>
            <hr />
            <p>總數量：<strong id="modal-count">0</strong></p>
            <p>總金額：<strong id="modal-price" class="text-danger">0</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">修改</button>
            <button type="button" class="btn btn-success" onclick="submitData()">確認送出訂單</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==========================================
      // ★ 請記得將下方網址換回您原本的 Google Script 網址 ★
      const API_URL = "https://script.google.com/macros/s/AKfycby9TYqRbHUv-7n5NyoprcaQJElKHp3XJHEwoWLpPcLGGJFAUgsXeAtKnHt46S27mrGzTw/exec";
      // ==========================================

      let selectedItems = new Set();
      const PRICE_TIERS = { 8: 320, 16: 640, 24: 960, 40: 1600 };

      // 支援按 Enter 加入自訂用語
      document.getElementById("custom-input").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          addCustomItem();
        }
      });

      // 初始化
      window.onload = function () {
        fetch(API_URL)
          .then((response) => response.json())
          .then((data) => {
            renderCategories(data);
            document.getElementById("loading-overlay").style.display = "none";
          })
          .catch((err) => {
            alert("讀取資料失敗，請檢查網路或稍後再試");
            console.error(err);
          });
      };

      function renderCategories(data) {
        const container = document.getElementById("content-area");
        container.innerHTML = "";

        for (const [category, items] of Object.entries(data)) {
          const catDiv = document.createElement("div");
          catDiv.className = "category-box text-start";

          let html = `<h5 class="cat-title">${category}</h5><div>`;
          items.forEach((item) => {
            const safeId = "btn-" + item.replace(/\s+/g, "-");
            html += `
          <input type="checkbox" class="btn-check" id="${safeId}" value="${item}" onchange="toggleItem(this)">
          <label class="btn btn-outline-success sticker-btn" for="${safeId}">${item}</label>
        `;
          });
          html += `</div>`;
          catDiv.innerHTML = html;
          container.appendChild(catDiv);
        }
      }

      // ★ 新增：處理自訂用語
      function addCustomItem() {
        const input = document.getElementById("custom-input");
        const val = input.value.trim();

        if (!val) return;
        if (selectedItems.has(val)) {
          alert("這個用語已經在您的選擇清單中囉！");
          input.value = "";
          return;
        }

        // 加入選擇集合
        selectedItems.add(val);

        // 建立視覺按鈕 (紅色樣式以示區別)
        const container = document.getElementById("custom-container");
        const safeId = "custom-" + Date.now();

        // 建立元素
        const wrapper = document.createElement("span");
        wrapper.innerHTML = `
        <input type="checkbox" class="btn-check" id="${safeId}" value="${val}" checked onchange="toggleItem(this)">
        <label class="btn btn-outline-danger sticker-btn" for="${safeId}">${val}</label>
    `;

        container.appendChild(wrapper);

        input.value = ""; // 清空輸入框
        updateStats(); // 更新統計
      }

      function toggleItem(checkbox) {
        if (checkbox.checked) selectedItems.add(checkbox.value);
        else selectedItems.delete(checkbox.value);
        updateStats();
      }

      function updateStats() {
        const count = selectedItems.size;
        let price = 0;

        if (count <= 8) price = 320;
        else if (count <= 16) price = 640;
        else if (count <= 24) price = 960;
        else if (count <= 40) price = 1600;
        else price = 1600 + (count - 40) * 40;

        document.getElementById("count-display").innerText = count;
        document.getElementById("price-display").innerText = price;
        document.getElementById("modal-count").innerText = count;
        document.getElementById("modal-price").innerText = price + " 元";

        const arr = Array.from(selectedItems);
        document.getElementById("selected-text-preview").innerText = arr.length ? arr.join("、") : "(尚未選擇)";
        document.getElementById("selected-list").innerHTML = arr.map((t) => `<span class="badge bg-success m-1">${t}</span>`).join("");

        const upsellMsg = document.getElementById("upsell-msg");
        upsellMsg.innerText = "";

        if (count > 8 && count < 16) {
          upsellMsg.innerText = `★ 目前以 16 張方案計費，還可以再選 ${16 - count} 張！`;
        } else if (count > 16 && count < 24) {
          upsellMsg.innerText = `★ 目前以 24 張方案計費，還可以再選 ${24 - count} 張！`;
        } else if (count > 40) {
          upsellMsg.innerText = `★ 注意：您已超過最大 40 張方案`;
        }
      }

      function submitData() {
        const name = document.getElementById("buyer-name").value;
        const lineId = document.getElementById("buyer-line").value;

        if (!name || !lineId) {
          alert("請填寫姓名與 Line ID");
          return;
        }
        if (selectedItems.size === 0) {
          alert("請至少選擇一個用語");
          return;
        }

        const btn = document.querySelector("#confirmModal .btn-success");
        btn.disabled = true;
        btn.innerText = "傳送中...";

        const orderData = {
          name: name,
          lineId: lineId,
          count: selectedItems.size,
          price: document.getElementById("price-display").innerText,
          selectedItems: Array.from(selectedItems),
        };

        fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(orderData),
          headers: { "Content-Type": "text/plain;charset=utf-8" },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              alert("訂單已送出成功！");
              location.reload();
            } else {
              alert("發生錯誤：" + data.message);
              btn.disabled = false;
              btn.innerText = "確認送出訂單";
            }
          })
          .catch((error) => {
            alert("連線錯誤，請檢查網路");
            console.error(error);
            btn.disabled = false;
            btn.innerText = "確認送出訂單";
          });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
